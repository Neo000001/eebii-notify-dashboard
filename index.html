<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Eebii Notify — WhatsApp Portal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Sign-In -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    const GOOGLE_CLIENT_ID = "1083797546343-qrtu176sr558amltve0c585vf1a27tsj.apps.googleusercontent.com.apps.googleusercontent.com.apps.googleusercontent.com";
  </script>

  <!-- optional: Google Analytics (replace G-XXXXXX) -->
  <!--
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXX"></script>
  <script>window.dataLayer=[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-XXXXXX');</script>
  -->

  <style>
    .card{@apply bg-white border border-slate-200 rounded-2xl shadow-sm p-5;}
    .btn{@apply inline-flex items-center justify-center px-4 py-2 rounded-xl font-medium transition;}
    .btn-primary{@apply bg-indigo-600 text-white hover:bg-indigo-700;}
    .btn-muted{@apply bg-slate-100 hover:bg-slate-200;}
    .input{@apply w-full border border-slate-300 rounded-xl px-3 py-2;}
    .label{@apply text-sm font-semibold text-slate-600;}
    .grid-2{@apply grid grid-cols-1 md:grid-cols-2 gap-4;}
    .grid-3{@apply grid grid-cols-1 md:grid-cols-3 gap-4;}
    pre{white-space:pre-wrap;word-break:break-word;}
    .toast{@apply fixed top-4 right-4 bg-black text-white text-sm px-4 py-2 rounded-lg shadow-lg opacity-0 translate-y-2;transition:.25s;}
    .toast.show{@apply opacity-100 translate-y-0;}
  </style>
</head>

<body class="bg-slate-50 min-h-screen">
  <div id="toast" class="toast">Saved</div>
  <div class="max-w-7xl mx-auto px-4 py-8">

    <!-- header -->
    <header class="mb-2 flex items-center justify-between">
      <a href="https://eebii.com" target="_blank" rel="noopener" class="flex items-center gap-3 group">
        <div class="w-10 h-10 rounded-2xl bg-indigo-600 grid place-items-center text-white font-bold group-hover:scale-105 transition">E</div>
        <div>
          <div class="text-2xl font-bold leading-tight group-hover:underline">Eebii Notify</div>
          <div class="text-slate-500 text-xs -mt-1">
            Product of <span class="text-indigo-600 underline decoration-dotted hover:decoration-solid">Eebii</span>
          </div>
        </div>
      </a>
      <nav class="flex items-center gap-3">
        <a href="https://eebii.com" target="_blank" rel="noopener" class="text-indigo-600 text-sm hover:underline">eebii.com</a>
        <button class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm" onclick="logout()">Logout</button>
      </nav>
    </header>

    <div id="greet" class="text-sm text-slate-600 mb-6"></div>

    <!-- Sign-in card -->
    <section id="authCard" class="card mb-6">
      <h2 class="font-semibold mb-3">Sign in</h2>
      <div id="g_id_signin" class="my-2"></div>
      <p class="text-xs text-slate-500">Use Google to enter the portal. No data is stored on our servers.</p>
    </section>

    <!-- connection -->
    <section class="card mb-6 requires-auth">
      <h2 class="font-semibold mb-3">Connection</h2>
      <div class="grid-3">
        <div><label class="label">API Base URL</label><input id="baseUrl" class="input" placeholder="https://eebii-api.onrender.com"></div>
        <div><label class="label">X-API-Key</label><input id="apiKey" class="input" placeholder="portal key…"></div>
        <div><label class="label">X-WA-Token</label><input id="waToken" class="input" placeholder="auto after connect"></div>
        <div><label class="label">X-WA-Phone-Id</label><input id="waPhone" class="input" placeholder="auto after connect"></div>
      </div>
      <div class="mt-3 flex gap-3">
        <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        <button class="btn btn-muted" onclick="ping()">Test</button>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary" onclick="connectMeta()">Connect WhatsApp</button>
        <span id="connectedInfo" class="ml-2 text-sm text-slate-600"></span>
      </div>
      <pre id="logSettings" class="mt-3 text-xs text-slate-600"></pre>
      <div id="ad-slot" class="my-4 grid place-items-center min-h-[90px]">
        <span class="text-slate-400 text-xs">Ad space — upgrade to Pro for ad-free</span>
      </div>
    </section>

    <!-- send text -->
    <section class="card requires-auth">
      <h2 class="font-semibold mb-3">Send Text</h2>
      <div class="grid-2">
        <div><label class="label">To (E.164)</label><input id="txtTo" class="input" placeholder="+91884…"></div>
        <div><label class="label">Message</label><input id="txtMsg" class="input" placeholder="Hello from Eebii!"></div>
      </div>
      <div class="mt-3 flex items-center gap-3">
        <button class="btn btn-primary" onclick="sendText()">Send</button>
        <details class="text-xs text-slate-600">
          <summary class="cursor-pointer hover:underline">WhatsApp pricing (Meta bills you)</summary>
          <div class="mt-2 p-3 rounded-xl border border-slate-200 bg-slate-50">
            <ul class="list-disc pl-5 space-y-1">
              <li><b>Marketing</b>: ~₹0.75</li>
              <li><b>Utility</b>: ~₹0.35</li>
              <li><b>Authentication</b>: ~₹0.40</li>
              <li><b>Service</b>: ~₹0.30</li>
            </ul>
            <div class="mt-2 text-[11px] text-slate-500">
              Meta charges your own WhatsApp Business Account directly.
            </div>
          </div>
        </details>
      </div>
      <pre id="logText" class="mt-3 text-xs"></pre>
    </section>

    <!-- contact strip -->
    <section class="mt-8 text-center text-sm">
      <div class="inline-flex items-center gap-4 bg-slate-100 rounded-xl px-4 py-2">
        <a href="https://wa.me/918848486417?text=Hi%20Eebii%20Support" target="_blank" rel="noopener" class="text-green-600 hover:underline">WhatsApp Support</a>
        <span>•</span>
        <a href="mailto:support@eebii.com" class="text-indigo-600 hover:underline">support@eebii.com</a>
        <span>•</span>
        <a href="tel:+918848486417" class="text-slate-700 hover:underline">+91 88484 86417</a>
      </div>
    </section>

    <!-- footer -->
    <footer class="mt-10 text-center text-sm text-slate-600">
      <hr class="my-4">
      <p class="mb-1">Product of <a href="https://eebii.com" target="_blank" rel="noopener" class="text-indigo-600 hover:underline font-medium">Eebii</a></p>
      <p class="text-slate-500 text-xs">
        <a href="/privacy.html" class="hover:underline">Privacy</a> · 
        <a href="/terms.html" class="hover:underline">Terms</a> · 
        <a href="/roadmap.html" class="hover:underline">Roadmap</a> · 
        <a href="/team.html" class="hover:underline">Team Policy</a>
      </p>
    </footer>
  </div>

  <!-- core scripts -->
  <script>
    const el=i=>document.getElementById(i);
    const toast=m=>{const t=el('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1600);}
    const log=(n,d)=>n.textContent=typeof d==='string'?d:JSON.stringify(d,null,2);
    const base=()=> (localStorage.getItem('eebii_base')||'https://eebii-api.onrender.com').replace(/\/+$/,'');
    const key =()=> (localStorage.getItem('eebii_api_key')||'').trim();
    const waT =()=> (sessionStorage.getItem('wa_token')||'').trim();
    const waP =()=> (sessionStorage.getItem('wa_phone_id')||'').trim();
    const H=()=>({'X-API-Key':key(),'X-WA-Token':waT(),'X-WA-Phone-Id':waP(),'Content-Type':'application/json'});

    // Greeting & auth state
    function greet(){
      const g=el('greet');if(!g)return;
      const lang=(navigator.language||'en').toLowerCase(),h=new Date().getHours();
      const hi=l=>l.startsWith('ml')?(h<12?'സുപ്രഭാതം':h<17?'സുഗന്ധ്യം':'ശുഭ രാത്രി'):(h<12?'Good morning':h<17?'Good afternoon':'Good evening');
      const name=sessionStorage.getItem('g_name')||'';const txt=lang.startsWith('ml')?`${hi(lang)} ${name?name:''}`:`${hi(lang)} ${name?name:''}`;
      g.textContent=txt;
    }

    function saveSettings(){
      localStorage.setItem('eebii_base',el('baseUrl').value.trim());
      localStorage.setItem('eebii_api_key',el('apiKey').value.trim());
      toast('Saved');
    }

    async function ping(){
      const r=await fetch(`${base()}/`,{headers:H()});log(el('logSettings'),await r.json());
    }

    // Send text
    async function sendText(){
      const b={to:el('txtTo').value.trim(),text:el('txtMsg').value};
      const r=await fetch(`${base()}/send/text`,{method:'POST',headers:H(),body:JSON.stringify(b)});
      log(el('logText'),await r.json());
    }

    // Meta connect
    async function connectMeta(){
      const r=await fetch(`${base()}/auth/meta/start`,{headers:{'X-API-Key':key()}});
      const j=await r.json();
      const w=window.open(j.authorize_url,'eebii_meta','width=900,height=800');
      window.addEventListener('message',function h(ev){
        if(!ev.data||ev.data.source!=='eebii-meta')return;
        window.removeEventListener('message',h);
        sessionStorage.setItem('wa_token',ev.data.access_token||'');
        sessionStorage.setItem('wa_phone_id',ev.data.phone_id||'');
        el('waToken').value=ev.data.access_token||'';
        el('waPhone').value=ev.data.phone_id||'';
        el('connectedInfo').textContent=`Connected ${ev.data.phone||ev.data.phone_id}`;
        toast('WhatsApp connected');
      });
    }

    // Google sign-in
    function parseIdToken(jwt){const p=jwt.split('.');if(p.length!==3)return null;return JSON.parse(atob(p[1].replace(/-/g,'+').replace(/_/g,'/')));}
    function googleCallback(r){const pl=parseIdToken(r.credential);if(!pl)return alert('Sign-in failed');
      sessionStorage.setItem('g_email',pl.email||'');sessionStorage.setItem('g_name',pl.name||'');onAuthStateChange();}
    function isLoggedIn(){return!!sessionStorage.getItem('g_email');}
    function logout(){sessionStorage.clear();localStorage.clear();location.reload();}
    function onAuthStateChange(){
      const logged=isLoggedIn();
      el('authCard').style.display=logged?'none':'block';
      document.querySelectorAll('.requires-auth').forEach(e=>e.style.display=logged?'':'none');
      greet();
    }
    function mountGoogle(){
      if(!window.google||!google.accounts)return;
      google.accounts.id.initialize({client_id:GOOGLE_CLIENT_ID,callback:googleCallback,ux_mode:'popup'});
      google.accounts.id.renderButton(document.getElementById('g_id_signin'),{theme:'outline',size:'large',shape:'pill'});
    }
    window.addEventListener('load',()=>{mountGoogle();onAuthStateChange();});
  </script>
</body>
</html>
